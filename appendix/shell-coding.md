# DevGuideline(APL) 別紙3.shellコーディング規約ドラフト版

# 目次
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->
- [目次](#目次)
  - [1 シェルコーディング規約](#1-シェルコーディング規約)
      - [1.1 概要](#11-概要)
        - [1.1.1 述対象](#111-記述対象)
        - [1.1.2 シェルの種類と構成](#112-シェルの種類と構成)
        - [1.1.3 変更履歴](#113-変更履歴)
      - [1.2 コーディングスタイル全般](#12-コーディングスタイル全般)
        - [1.2.1 行の文字数](#121-行の文字数)
        - [1.2.2 インデント](#122-インデント)
        - [1.2.3 空白行](#123-空白行)
        - [1.2.4 条件分岐](#124-条件分岐)
        - [1.2.5 繰り返し](#125-繰り返し)
        - [1.2.6 シェル変数・環境変数の参照](#126-シェル変数環境変数の参照)
      - [1.3 構文および機能に関する規約](#13-構文および機能に関する規約)
        - [1.3.1 シェル引数](#131-シェル引数)
        - [1.3.2 シェルの入れ子](#132-シェルの入れ子)
        - [1.3.3 制御演算子](#133-制御演算子)
        - [1.3.4 数値演算](#134-数値演算)
        - [1.3.5 パイプ](#135-パイプ)
        - [1.3.6 リダイレクト](#136-リダイレクト)
        - [1.3.7 ヒアドキュメント](#137-ヒアドキュメント)
        - [1.3.8 コマンド置換](#138-コマンド置換)
        - [1.3.9 ヌルコマンド](#139-ヌルコマンド)
        - [1.3.10 ヌル](#1310-ヌル)
        - [1.3.11 su](#1311-su)
      - [1.4 コメント](#13-コメント)
        - [1.4.1 行末コメント](#131-行末コメント)
        - [1.4.2 行コメント](#132-行コメント)
      - [1.5 ヘッダ](#16-ヘッダ)
        - [1.5.1 実行シェルの指定](#151-実行シェルの指定)
        - [1.5.2 ヘッダコメント](#152-ヘッダコメント)
      - [1.6 シェル関数定義](#16-シェル関数定義)
        - [1.6.1 初期処理](#161-初期処理)
          - [1.6.1.1 環境設定](#1611-環境設定)
          - [1.6.1.2 変数の初期化](#1612-変数の初期化)
          - [1.6.1.3 固有の初期処理](#1613-固有の初期処理)
        - [1.6.2 正常終了処理](#162-正常終了処理)
          - [1.6.2.1 環境のクリア](#1621-環境のクリア)
          - [1.6.2.2 固有の終了処理](#1622-固有の終了処理)
        - [1.6.3 異常終了処理](#163-異常終了処理)
          - [1.6.3.1 環境のクリア](#1631-環境のクリア)
          - [1.6.3.2 固有の終了処理](#1632-固有の終了処理)
      - [1.7 スクリプト本体（メイン処理）](#17-スクリプト本体メイン処理)
        - [1.7.1 初期処理の呼び出し](#171-初期処理の呼び出し)
        - [1.7.2 プログラムおよびコマンドの実行](#172-プログラムおよびコマンドの実行)
        - [1.7.3 正常終了処理の呼び出し](#173-正常終了処理の呼び出し)
        - [1.7.4 リターンステータスの返却](#174-リターンステータスの返却)
          - [1.7.4.1 リターンステータスのチェック](#1741-リターンステータスのチェック)
          - [1.7.4.2 リターンステータスのセット](#1742-リターンステータスのセット)




          
# 1 シェルコーディング規約

- 本章の参照者<br>


|各ビジネス機能</br>(A01)|各ビジネス機能</br>(B01)|各ビジネス機能</br>(C01)|システム機能共通|共通機能|DB-API|
| :----:| :----: | :----: | :----: | :----: | :----: |
|×  |× |○ |× |× |× |
<BR>

## 1.1 概要
### 1.1.1 記述対象
新規作成するシェルスクリプトとする。  
ツールによって自動生成するシェル(ジョブシェル)については対象外とする。また、開発中に、開発者固有のツールとして使用する場合のシェルや、テスト用のシェルについても対象外とする。

# 1.1.2 シェルの種類と構成
統一性の観点から、原則としてスクリプトに利用するシェルの種類をBシェル（Borneシェル … /bin/sh）に限定する。
- Bシェルで何か不都合がある場合や、特殊な事情で他の種類のシェル使用を希望する場合は、その必要性を個別に判断し、他のBシェル系のシェル（bashまたはksh）を使用可とする。
- リモートシェル（/usr/bin/rsh）は使用不可。遠隔操作を必要とする場合のみ、セキュアリモートシェル（/usr/bin/ssh）を使用可とする。
- 汎用性（互換性）と速度を考慮し、csh系のシェルは使用しない。
    - Cシェル系では、使用できるシグナルに制限がある。
    - 仮にOSが変更されても、UNIX系OSのデフォルトシェルであり、システムのブート段階でも動作可能なBシェルであれば、最も互換性の問題が少ない。
- シェルスクリプト上で使用する文字セットについては、OSやDBと合わせることを前提としてShiftJISをデフォルトとする。

シェルスクリプトは次の３つのブロックで構成する。
ただし、メインシェル（親シェル）から呼び出されるサブシェル（子シェル）については、共通初期処理および共通終了処理の呼び出しは行わないものとする。

```sh
---------------
ヘッダ
  シェルの宣言
  ヘッダコメント
---------------
シェル関数定義
  例：固有初期処理、固有終了処理、エラー処理
---------------
スクリプト本体（メイン処理）
  共通初期処理の呼び出し
  （固有初期処理の呼び出し）
  メイン処理（例：コマンド、プログラム呼び出し、エラー処理）
  （固有終了処理の呼び出し）
  共通終了処理の呼び出し
  リターンステータスの返却
---------------
```

### 1.1.3 変更履歴  

変更履歴はバージョン管理システムを使って追跡することとし、変更履歴コメントなどは記載しない。  


## 1.2 コーディングスタイル全般
### 1.2.1 行の文字数
コンソール表示を考慮し、1行の長さは80バイト以下とする
- コード中で使用するリテラルの長さが、インデントを含めて80バイトを超える場合を除く。
- インデントやパイプの結合などにより、これを超える場合は、区切りの良い部分で改行する。
ただし、そのように1行が長くなる構造が正しいのか、検討する必要がある。

### 1.2.2 インデント
半角空白4文字とし、**TAB** は使用禁止とする
- TABは個別の環境に依存するため、インデントが崩れて表示される場合がある。

### 1.2.3 空白行
可読性向上のため、適宜、空白行を入れること
- シェルスクリプトを構成する３つのブロック間では、２行の空白行を入れる。
  - ヘッダ：シェル関数定義
  - シェル関数定義：スクリプト本体
- 少なくとも、以下の部分では1行の空白行を入れる。
  - シェル関数定義：各シェル関数の間
  - スクリプト本体：各ステップ間。各プログラムまたはシェル関数呼び出しの間。

### 1.2.4 条件分岐
(1)	if文
- 予約語（**if, then, else, elif, fi**）のインデントを揃えること

```sh
例：	
pwd
ret=$?
if test ${ret} -eq 0
then 
    echo "succeed"
else
     echo "error"
fi
```

(2)	case文
- 予約語（**case, esac**）およびケース値（ * を含む）のインデントを揃えること
- **“;;”** は1行とすること（直前で改行すること）

```sh
例：
case "$1" in
start) 
    echo start
    ;;
stop)
    echo stop
    ;;
*)
    echo "Usage {start|stop}"
    exit 1
esac
```
### 1.2.5 繰り返し

(1)	if文
- 予約語（**for, do, done**）のインデントを揃えること

```sh
例：	
for name in `find ./ -type d`;
do
    echo $name
done
```

(2)	if文
- 予約語（**while, do, done**）のインデントを揃えること

```sh
例：	
num=$1;
count=0;

while [ $count -lt $num ]
do 
    count=`expr $count + 1`
    	echo $count;
done
```

### 1.2.6 シェル変数・環境変数の参照
シェル変数は「\$変数名」で、環境変数はブレスで括り「\${変数名}」の形式で参照する。


## 1.3	構文および機能に関する規約

シェルスクリプトの内容が複雑になることを避けるため、できる限り単純な構文を使用すること。

できる限り、繰り返し構造をもたない、単純な構造とする。
- データ処理はプログラム内での実行が望ましい。
- 繰返し処理が必要な場合は、for文またはwhile文を使用して記述し、until文は使用しない。

if文を使用する場合は単純な形式（**if-else-fi**）を使用し、if文の入れ子は極力避けること。
- 単純な形式（if-else-fi）の記述が難しい場合もelifの使用を避け、case文での記述を検討する。

### 1.3.1 シェル引数
シェル引数は、初期処理において（意味のある命名をもつ）変数に代入する。
- 可読性が低下するため、シェル関数またはスクリプト本体で、そのまま使用しない。
```sh
例：
	$ setargs.sh a1
上記コマンド形式における例）
	SSID = `echo $0 | sed ‘s/.sh$//’`  # 拡張子を除去したシェル名($0)をセット
	first_arg = $1                     # 第1引数をセット
	export  SSID
```

### 1.3.2 シェルの入れ子
共通シェル部品などサブシェル（子シェル）内では、サブシェルの呼び出し（入れ子）は行わない。つまり、”親 → 子”の2階層まで。
- 設計上、他に手段がない場合や、むしろ入れ子を行う方が理解しやすくなる場合を除く。

### 1.3.3 制御演算子
AND演算子（**&&**）およびOR演算子（**||**）は、プログラムの呼び出し結果には使用しない。
- 可読性の低下を防止するため。プログラムのエラー処理の間違いを防ぐため。
- Bシェルの組み込みコマンドおよびOS標準のコマンドについては使用可とする。
- ただし、制御演算子を使用する場合、処理内容を説明するコメントを付記すること。
  
```sh
例：
	# 引数指定された年の２月のカレンダーで、下２桁の２９の有無により、うるう年を判定
	year = $1
	cal 02 $year | tail –n 2 | grep 29 > /dev/null && echo “Olympic year!”
	cal 02 $year | tail –n 2 | grep 29 > /dev/null || echo “normal year…”
```
### 1.3.4 数値演算
基本的には、数値演算は **$((** 計算式 **))** の形式とする
- exprコマンドは、Bシェルの組み込みコマンドではないので、多用するとパフォーマンスが低下する。特に、1万回以上のループのカウンタなどには使用しない方が良い。

### 1.3.5 パイプ
パイプによって得た値を別の箇所でも利用する場合は、変数に代入すること
- パイプ使用による可読性の低下を緩和するため、処理内容を説明するコメントを付記すること。

基本的には、パイプの使用は1行につき2回以内とする
- 区切りの良いところで変数に代入するなど、処理を分けることを検討する。
- 設計上、他に手段がない場合や、むしろパイプを使用した方が理解しやすくなる場合は3回以上も可とする。

### 1.3.6 リダイレクト
リダイレクトの使用は、下表の通りとする。
|書式|説明|
|---|---|
|<|入力のリダイレクト  ※ << は、次節にヒアドキュメントとして記述
|>|標準出力のリダイレクト|
|>>|追加出力|
|2>|エラー出力のリダイレクト|
|1>&2|標準出力をエラー出力先へリダイレクト|
|2>&1|エラー出力を標準出力先へリダイレクト|

- シェルスクリプト内で呼び出すプログラムによるログ出力先はログファイルであることを前提とする。
- プログラム以外のコマンド等による出力は、標準エラー出力へのエラーログを含め、標準出力へリダイレクトする。また、原則として、同時にファイルにも出力する（tee利用、等）。
- 基本的には全情報を出力するが、不要な情報と判断された標準出力をサプレスする場合は、**dev/null** にリダイレクトする。

### 1.3.7 ヒアドキュメント
ヒアドキュメントの使用は、複数行の入力や会話形式の入力が必要な場合に限定する。
- 可読性の低下を避けるためであり、複数行であっても、使用することで理解しやすくなる場合にのみ使用する（メニュー表示データのセットや、連続した入力、など）。
- 入力終端を示すキーワードは英大文字および数字とする。
- ヒアドキュメントを使用する場合、処理内容や開始・終了を示すコメントを付記すること。
```sh
例：
HOST_NAME="ホスト名またはIPアドレス"
USER_NAME="ftpユーザー名"
PASSWORD="パスワード"
LOCAL_DIR="ローカル側の作業ディレクトリ"
GET_DIR="ftp先の作業ディレクトリ"
FILE_NAME="getするファイル名"

# FTP自動化のため、ヒアドキュメントで入力
ftp -n ${HOST_NAME} << EOFMARK
user ${USER_NAME} ${PASSWORD}
bin
lcd ${LOCAL_DIR}
cd ${GET_DIR}
get ${FILE_NAME}
bye
EOFMARK
# ヒアドキュメントの終端
```

### 1.3.8 コマンド置換
コマンド置換によって得た値を別の箇所でも利用する場合は、変数に代入すること
- 複雑な構文になる場合は、一度しか利用しない場合でも、変数に入れて利用する事を検討する必要がある。
- コマンド置換使用による可読性の低下を緩和するため、処理内容を説明するコメントを付記すること。
```sh
例：
flightdate =`date` 	# フライト日に本日日付を設定
echo $flightdate
```

### 1.3.9 ヌルコマンド
永久ループが必要な場合は、条件値にヌルコマンド **”:”** （ステータス=0）を使用する
- “while true” と記述することも可能だが、trueは組み込みコマンドではないため。
- 特殊な事情がない限り、if文の分岐にはヌルコマンドは使用しない。
（通常は別の構造で記述可能であるため）
```sh
例：
	while :; 
	do
		mailq;
		sleep 5;
	done;
```
### 1.3.10 ヌル
ヌル値は、**””**（ダブルクォート2つ）で表す
- 統一性と可読性を考慮し、‘ ’（シングルクォートで囲んだ空白）や「値なし」にしないこと。

ヌルファイルは、**/dev/null**で表す
```sh
例：
	airline_code = “”        # 変数airline_codeのクリア
	cat /dev/null > data.xml # データファイルをクリアする（空になる）
	echo “” > result.txt     # 結果ファイルをクリアする（改行一つになる）
```
### 1.3.11 su
原則として、APのシェルスクリプト内では、**su（switch user）** は使用しない。
- root等、特定のユーザで実行する必要があるシェルは、当該ユーザのシェルとして実行する。
- ただし、インフラのシェル等、必要性が認められる場合は、この限りではない。


## 1.4 コメント
### 1.4.1 行末コメント
行単位で処理の説明が必要な場合は、**#** 以降に行末コメントを記述する
- 可読性向上のため、可能な限り記述するとよい（例えば、次のような場合）。
  - シェル変数（またはシェル引数）の意味および取り得る値。
  - シェルコマンドの処理内容が複雑な場合や、処理対象が理解しにくい場合。
  - if文、while文などの処理条件が複雑な場合。
  - その他、パイプやコマンド置換、ヒアドキュメントなど複雑な構文の場合。

### 1.4.2 行コメント
行末コメントとすると1行の文字数制限を超えてしまう場合、コメント対象の行の直前に行コメントとして記述する。
- 行コメントのインデント（開始位置）は、コメント対象の行に合わせる。
```sh
例：
# 桁数表示ヘッダ：桁数のガイドとするための50桁の数字列
column = “01234567890123456789012345678901234567890123456789”
```

## 1.5 ヘッダ
ヘッダは、以下の形式(実行シェルの指定、ヘッダコメント)とする。
```sh
#!/bin/sh
# -----------------------------------------------------------
# 
# 処理名称） 
#	団体予約状態表示
# 機能概要） 
#	指定された日付の予約コードとステータスを標準出力に表示する
# 起動形式） 
# 	CASP-A101002_01_printgroup.sh yyyymmdd
#		yyyymmdd : 表示する年月日を指定
# 作成）
#	2021/09/30	：ASY - ruby - Taro Sorano
#------------------------------------------------------------
```

### 1.5.1 実行シェルの指定
シェルスクリプトの開始行（1行目）で実行シェルの種類を明示的に指定すること

### 1.5.2 ヘッダコメント
上記の形式で、以下の項目を記述する
- 処理名称	：内容を端的に表す、任意の日本語名称
- 機能概要	：スクリプトが実行可能な機能の概要を記述
- 作成		：最初の単体テスト完了日と、会社名（ASY固定）、（チーム名　英語表記）、作成者名（英語表記のフルネーム(名 性)）

## 1.6 シェル関数定義

当該シェルスクリプト内で共通利用可能な固有の処理は、ここで関数化して定義する

- シェル関数内ではステップ分けしないこと
- 可読性を考慮し、シェル関数の入れ子呼び出しは行わない
  - 設計上、他に手段がない場合や、むしろ入れ子を行う方が理解しやすくなる場合を除く。
- シェル関数はreturn文でリターンステータスをセットすること

```sh
例：
RETVAL=0
prog="qmail"

start() {
        # Start daemons.

        echo -n $"Starting $prog: "

        daemon /var/qmail/rc

        RETVAL=$?
        echo
        [ ${RETVAL} -eq 0 ] && touch /var/lock/subsys/qmail
        return ${RETVAL}
}
```

### 1.6.1 初期処理
初期処理はシェル関数で定義するものとし、必要となる初期処理を次項以降に示す。

#### 1.6.1.1 環境設定
作業環境のチェックや設定を行う。
- シェル引数をチェック
  - 起動形式に誤りがある場合は、usageを出力する。
- 作業ディレクトリの有無をチェック
  - エラー処理の呼び出し、または、必要であればディレクトリを作成する。
  - JP1上では実行開始時のみ可能であるため、シェル内で実施するものとする。
- ファイルの有無をチェック
  - エラー処理の呼び出し、または、ファイルの消去・リネームを実行する。
  - JP1上では実行開始時のみ可能であるため、シェル内で実施するものとする。
- ツールで設定する変数は、プログラムで内容を取得可能とするため環境変数に設定する。
  - JP1上で設定する環境変数を含む。
  - 環境変数用のプロパティファイルを使用して設定することを可とする。

なお、シェルスクリプトを複数OSで動作させる必要がある場合、以下のようなOSによる差異の調整を初期処理で行う。
（作成したシェルスクリプトが、動作保証対象とする各OSで同様に動作するよう調整する必要がある）
- システムが提供する環境変数名の違い
- ディレクトリ構造の違い
- コマンド名の違い

#### 1.6.1.2 変数の初期化
シェル変数、環境変数の初期化を行う。以下のような変数が考えられる。
- ファイルやコマンド類のアクセスパスのセット
- 各種フラグ類の初期化

#### 1.6.1.3 固有の初期処理
その他、初期化すべきものがあれば、ここで初期化を行う。

- root等、特定のユーザで実行する必要があるシェルに関しては、実行時にユーザIDを確認する。
  - 想定外のユーザIDで実行された場合はエラー終了する。

### 1.6.2 正常終了処理
正常終了処理はシェル関数で定義するものとし、必要となる終了処理を次項以降に示す

#### 1.6.2.1 環境のクリア
初期処理で設定したワークファイルやワークディレクトリなどの作業環境は、必要に応じてクリアまたは削除する。

- 仕様として保管が求められる中間ファイルなどは削除しないこと
- ファイルサイズが非常に大きいなど特殊な場合を除き、デバッグ用途などを考慮し、固定pathのテンポラリーファイル（パイプの途中結果など）は削除しなくてよいものとする。
- 上記以外の中間ファイル、ワークファイルなどの作業環境は、クリアまたは削除する。  
  

また、変更された環境変数を元に戻す場合も、ここで実行する。

#### 1.6.2.2 固有の終了処理
その他、クリアもしくはクローズすべきものがあれば、ここで終了処理を行う。

### 1.6.3 異常終了処理
異常終了処理はシェル関数で定義するものとし、必要となる終了処理を次項以降に示す

#### 1.6.3.1 環境のクリア
基本的には、正常終了処理と同様とする（クリアまたは削除などの処理などが必要）。
ただし、正常終了時と異常終了時の違いについて考慮すること。

- 正常終了処理では削除するファイルでも、異常終了時には削除しない場合もあるため、考慮すること（環境変数についても同様の考慮が必要）。

#### 1.6.3.2 固有の終了処理
その他、クリアもしくはクローズすべきものがあれば、ここで終了処理を行う。

- リランに制御用ファイルの作成が必要な場合などについて、考慮すること

## 1.7 スクリプト本体（メイン処理）
本ブロックは、ステータスをチェックする単位（おおよそ１アプリケーション／コマンド単位）でステップに分割して記述する。（ステップごとに簡単な概要を示すコメントを付記すること）

### 1.7.1 初期処理の呼び出し
初期処理を行うシェル関数を呼び出す。リターンステータスのチェックについては後述する。

### 1.7.2 プログラムおよびコマンドの実行
アプリケーションプログラムや、シェルコマンドを実行する。リターンステータスのチェックについては後述する。

- サーバ名、IPアドレスは、外部パラメータ化する。
  - 今後のサーバ増設、IPアドレス変更等を考慮し、できる限りハードコーディングしない  
- aliasの影響を回避するため、以下のコマンドを使用する場合は、フルパスでシェル変数として定義した後、それを使用する。
  - **ｌｓ**コマンド
  - **ｒｍ**コマンド
  - その他、特殊なコマンド等
- サーバリソースの移動および削除を行うコマンドについては、使用直前に環境変数がセットされているか確認すること
  - 以下の例では、TMP_PATHへ値がセットされていないとエラーとなる。
```sh
例：
if  [  x  ==  x${TMP_PATH}  ] then
	echo    error TMP_PATH is not set !!	>&2
	echo    check env file  !!			>&2
	exit 1
fi
${RM} 		${TMP_PATH}/* 
```

重要な処理の途中経過について、ログ出力すること
- ポイントとなる処理のみ。必ずしもステップ毎に出力する必要はない。
- コマンド毎の出力は避けること。

### 1.7.3 正常終了処理の呼び出し
正常終了処理を行うシェル関数を呼び出す。リターンステータスのチェックについては後述する。

### 1.7.4 リターンステータスの返却
シェルスクリプトの終了時に、呼び出し元（JP1や親シェル）へリターンステータスを返却する。
```sh
例：
	exit 0 
```
#### 1.7.4.1 リターンステータスのチェック
- 各ステップおよび各アプリケーションプログラムの実行後、その終了状態をチェックする

- 終了状態は実行後ステータス（**$?**）でチェックし、正常終了でない場合は異常終了処理を呼ぶ

#### 1.7.4.2 リターンステータスのセット
必ずexit文でリターンステータスをセットし、終了すること（サブシェルも含む）

- 正常終了の場合はexit(0)で終了する。
- エラーを検知して異常終了させる場合は、異常終了処理の呼び出し後、exit(1) で終了する。  
※ 今後、他のステータスが必要となった場合は、その都度、追加する。  

<!--2021.09.30.addend　 ⑤開発ガイドラインに不足している要素の取込(ableから) -->
